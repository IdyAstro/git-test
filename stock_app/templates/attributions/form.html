{% extends "attributions/base.html" %}
{% load widget_tweaks %}   {# Obligatoire pour add_class #}

{% block content %}
<div class="p-6 max-w-5xl mx-auto">

  <!-- Header -->
  <div class="mb-6 flex items-center justify-between">
    <h1 class="text-3xl font-bold text-[#004F9F] flex items-center gap-2">üì¶ Nouvelle Attribution</h1>
    <a href="{% url 'liste_attributions' %}" 
       class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-xl shadow transition">
       üìë Historique
    </a>
  </div>

  <!-- Messages Django -->
  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for message in messages %}
        <div class="
          px-4 py-2 rounded-lg text-sm font-medium shadow-md
          {% if message.tags == 'error' %} bg-red-100 text-red-800 border border-red-300
          {% elif message.tags == 'success' %} bg-green-100 text-green-800 border border-green-300
          {% elif message.tags == 'warning' %} bg-yellow-100 text-yellow-800 border border-yellow-300
          {% else %} bg-blue-100 text-blue-800 border border-blue-300
          {% endif %}
        ">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Formulaire Wizard -->
  <form method="post" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-8">
    {% csrf_token %}

    <!-- Progress bar -->
    <div class="flex justify-between mb-6">
      <div class="step-indicator flex-1 text-center">
        <div class="w-10 h-10 mx-auto rounded-full flex items-center justify-center bg-[#004F9F] text-white">1</div>
        <p class="text-sm mt-2">Infos g√©n√©rales</p>
      </div>
      <div class="step-indicator flex-1 text-center">
        <div class="w-10 h-10 mx-auto rounded-full flex items-center justify-center bg-gray-300 text-gray-600">2</div>
        <p class="text-sm mt-2">Mat√©riels</p>
      </div>
      <div class="step-indicator flex-1 text-center">
        <div class="w-10 h-10 mx-auto rounded-full flex items-center justify-center bg-gray-300 text-gray-600">3</div>
        <p class="text-sm mt-2">Validation</p>
      </div>
    </div>

    <!-- Slide 1 : Infos g√©n√©rales -->
    <div id="step-1" class="step">
      <h2 class="text-lg font-semibold text-[#004F9F] mb-4 border-b pb-2">üìù Informations g√©n√©rales</h2>
      <div class="grid md:grid-cols-4 gap-6">
        {% for field in attribution_form %}
          <div class="flex flex-col">
            <label class="mb-1 font-medium text-gray-600">{{ field.label_tag }}</label>
            {{ field|add_class:"border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#004F9F] focus:border-[#004F9F]" }}
            {% if field.errors %}
              <span class="text-red-600 text-sm mt-1">{{ field.errors|striptags }}</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Slide 2 : Mat√©riels -->
    <div id="step-2" class="step hidden">
      <h2 class="text-lg font-semibold text-[#004F9F] mb-4 border-b pb-2">‚ûï Mat√©riels attribu√©s</h2>
      {{ formset.management_form }}
      <div id="materiels-list" class="space-y-4">
        {% for form in formset %}
          <div class="grid md:grid-cols-2 gap-4 items-end bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
            <div class="flex flex-col">
              <label class="mb-1 font-medium text-gray-600">{{ form.materiel.label_tag }}</label>
              {{ form.materiel|add_class:"border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#004F9F] focus:border-[#004F9F]" }}
              {% if form.materiel.errors %}
                <span class="text-red-600 text-sm mt-1">{{ form.materiel.errors|striptags }}</span>
              {% endif %}
            </div>
            <div class="flex flex-col">
              <label class="mb-1 font-medium text-gray-600">{{ form.quantite.label_tag }}</label>
              {{ form.quantite|add_class:"border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#004F9F] focus:border-[#004F9F]" }}
              {% if form.quantite.errors %}
                <span class="text-red-600 text-sm mt-1">{{ form.quantite.errors|striptags }}</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Slide 3 : Validation -->
    <div id="step-3" class="step hidden">
      <h2 class="text-lg font-semibold text-[#004F9F] mb-4 border-b pb-2">‚úÖ Validation</h2>
      <p class="text-gray-600 mb-6">V√©rifiez bien vos informations avant d‚Äôenregistrer cet deploiement.</p>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between items-center pt-6">
      <button type="button" id="prevBtn" class="hidden bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg shadow transition">
        ‚¨ÖÔ∏è Pr√©c√©dent
      </button>

      <button type="button" id="nextBtn" class="bg-[#004F9F] hover:bg-blue-900 text-white px-6 py-2 rounded-lg shadow transition ml-auto">
        Suivant ‚û°Ô∏è
      </button>

      <button type="submit" id="submitBtn" class="hidden bg-green-600 hover:bg-green-800 text-white px-6 py-2 rounded-lg shadow transition ml-auto">
        ‚úÖ Enregistrer
      </button>
    </div>

  </form>
</div>

<!-- Script -->
<script>
  let currentStep = 1;
  const totalSteps = 3;

  const steps = document.querySelectorAll(".step");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const indicators = document.querySelectorAll(".step-indicator div");

  function showStep(step) {
    steps.forEach((el, i) => {
      el.classList.toggle("hidden", i !== step - 1);
      indicators[i].classList.toggle("bg-[#004F9F]", i === step - 1);
      indicators[i].classList.toggle("text-white", i === step - 1);
      indicators[i].classList.toggle("bg-gray-300", i !== step - 1);
      indicators[i].classList.toggle("text-gray-600", i !== step - 1);
    });

    prevBtn.classList.toggle("hidden", step === 1);
    nextBtn.classList.toggle("hidden", step === totalSteps);
    submitBtn.classList.toggle("hidden", step !== totalSteps);
  }

  nextBtn.addEventListener("click", () => {
    if (currentStep < totalSteps) {
      currentStep++;
      showStep(currentStep);
    }
  });

  prevBtn.addEventListener("click", () => {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  });

  showStep(currentStep);
</script>
{% endblock %}
