{% extends "attributions/base.html" %}

{% block content %}
<div class="space-y-8">

  <!-- Titre + Export -->
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-[#004F9F]">üìë RAPPORT GLOBAL DES DEPLOIEMENTS</h1>
    <div>
      <a href="?export=excel" 
         class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
        üì• Exporter en Excel
      </a>
    </div>
  </div>

  <!-- Section 1 : Synth√®se par cat√©gorie -->
  <div class="bg-white shadow rounded-lg p-4">
    <h2 class="text-lg font-semibold text-[#004F9F] mb-3">1Ô∏è‚É£ Synth√®se par Cat√©gorie</h2>
    <table class="table-auto border-collapse border border-gray-300 w-full text-sm">
      <thead class="bg-[#F58220] text-white">
        <tr>
          <th class="border p-2">Cat√©gorie</th>
          <th class="border p-2">Approvisionn√©</th>
          <th class="border p-2">Attribu√©</th>
          <th class="border p-2">Stock</th>
        </tr>
      </thead>
      <tbody>
        {% for c in categories %}
         
         
        <tr class="hover:bg-gray-100">
          <td class="border p-2">{{ c.label }}</td>
          <td class="border p-2 text-center">{{ c.total_appro|default:0 }}</td>
          <td class="border p-2 text-center">{{ c.total_attri|default:0 }}</td>
          
          <td class="border p-2 text-center font-semibold text-green-600">{{ c.stock|default:0 }}</td>
          
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Section 2 : R√©partition par direction -->
  <div class="bg-white shadow rounded-lg p-4">
    <h2 class="text-lg font-semibold text-[#004F9F] mb-3">2Ô∏è‚É£ Deploiement par Direction</h2>
    <table class="table-auto border-collapse border border-gray-300 w-full text-sm">
      <thead class="bg-[#F58220] text-white">
        <tr>
          <th class="border p-2">Direction</th>
          <th class="border p-2">Quantit√© Deploiyer</th>
        </tr>
      </thead>
      <tbody>
        {% for d in directions %}
        <tr class="hover:bg-gray-100">
          <td class="border p-2">{{ d.direction }}</td>
          <td class="border p-2 text-center font-semibold">{{ d.total_attribue|default:0 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Section 3 : D√©tails des attributions -->
  <div class="bg-white shadow rounded-lg p-4">
    <h2 class="text-lg font-semibold text-[#004F9F] mb-3">3Ô∏è‚É£ D√©tails des Deploiement</h2>
    <div class="overflow-x-auto">
      <table class="table-auto border-collapse border border-gray-300 w-full text-sm">
        <thead class="bg-[#F58220] text-white">
          <tr>
            <th class="border p-2">Date</th>
            <th class="border p-2">R√©f</th>
            <th class="border p-2">Employ√©</th>
            <th class="border p-2">Email</th>
            <th class="border p-2">Direction</th>
            <th class="border p-2">D√©partement</th>
            <th class="border p-2">Service</th>
            <th class="border p-2">Mat√©riel</th>
            <th class="border p-2">Quantit√©</th>
            <th class="border p-2">√âtat</th>
          </tr>
        </thead>
        <tbody>
          {% for attri in attributions %}
            {% for mat in attri.attribumateriel_set.all %}
            <tr class="hover:bg-gray-100">
              <td class="border p-2">{{ attri.date_attri|date:"Y-m-d H:i" }}</td>
              <td class="border p-2">{{ attri.ref }}</td>
              <td class="border p-2">{{ attri.prenom }} {{ attri.nom }}</td>
              <td class="border p-2">{{ attri.email }}</td>
              <td class="border p-2">{{ attri.direction }}</td>
              <td class="border p-2">{{ attri.departement }}</td>
              <td class="border p-2">{{ attri.service }}</td>
              <td class="border p-2">{{ mat.materiel }}</td>
              <td class="border p-2 text-center">{{ mat.quantite }}</td>
              <td class="border p-2 font-semibold">{{ attri.etat }}</td>
            </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- Section 4 : Mat√©riels anciens √† remplacer -->
<div class="bg-white p-6 rounded shadow mt-8">
  <h2 class="text-xl font-bold text-red-600 mb-4">‚ö†Ô∏è Equipements anciens √† remplacer (+3 ans)</h2>
  {% if materiels_a_remplacer %}
    <table class="min-w-full border border-gray-200 text-sm">
      <thead class="bg-red-100">
        <tr>
          <th class="px-4 py-2 border">Nom</th>
          <th class="px-4 py-2 border">Cat√©gorie</th>
          <th class="px-4 py-2 border">Date d‚Äôacquisition</th>
          <th class="px-4 py-2 border">√âtat</th>
        </tr>
      </thead>
      <tbody>
        {% for m in materiels_a_remplacer %}
        <tr class="hover:bg-gray-50">
          <td class="border px-4 py-2">{{ m.nom }}</td>
          <td class="border px-4 py-2">{{ m.categorie.label }}</td>
          <td class="border px-4 py-2">{{ m.date_acquisition|date:"d/m/Y" }}</td>
          <td class="border px-4 py-2">{{ m.etat }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-gray-500">‚úÖ Aucun mat√©riel ancien √† remplacer.</p>
  {% endif %}
</div>


</div>
{% endblock %}
