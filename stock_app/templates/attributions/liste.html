{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto space-y-8">

  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-900 flex items-center gap-2">
        📋 Historique des Déploiements
      </h1>
      <p class="text-gray-500 text-sm">Visualisez, filtrez et exportez facilement vos déploiements</p>
    </div>
    <a href="{% url 'nouvelle_attribution' %}"
       class="inline-flex items-center gap-2 bg-gradient-to-r from-[#004F9F] to-[#2563EB] hover:opacity-90 text-white px-5 py-3 rounded-xl shadow-lg font-medium transition">
      <i class="fa-solid fa-plus"></i> Nouveau déploiement
    </a>
  </div>

  <!-- Messages Django -->
  {% if messages %}
    <div class="space-y-2">
      {% for message in messages %}
        <div class="px-4 py-3 rounded-xl text-sm font-medium shadow-md border
          {% if message.tags == 'success' %} bg-green-50 text-green-700 border-green-200
          {% elif message.tags == 'error' %} bg-red-50 text-red-700 border-red-200
          {% elif message.tags == 'warning' %} bg-yellow-50 text-yellow-700 border-yellow-200
          {% else %} bg-blue-50 text-blue-700 border-blue-200
          {% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Barre de recherche + Filtres -->
  <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 space-y-5">
    <form method="get" x-data="{}" class="space-y-6">

      <!-- Recherche -->
      <div class="flex flex-col md:flex-row gap-3">
        <input type="text" name="q" placeholder="🔍 Rechercher par usager ou référence"
               value="{{ request.GET.q }}"
               class="border border-gray-300 rounded-xl px-4 py-3 w-full md:w-80 focus:ring-2 focus:ring-[#004F9F] focus:border-[#004F9F] shadow-sm placeholder-gray-400">
        <button type="submit"
                class="bg-[#004F9F] hover:bg-blue-900 text-white px-5 py-3 rounded-xl shadow flex items-center gap-2 transition">
          <i class="fa-solid fa-magnifying-glass"></i> Rechercher
        </button>
      </div>

      <!-- Filtres dynamiques -->
      <div class="flex flex-wrap gap-3">
        {% for field in radio_fields %}
        <div class="relative" x-data="{ open: false }">
          <button type="button" @click="open = !open"
                  class="px-4 py-2 bg-gray-100 rounded-xl text-gray-700 shadow-sm text-sm flex items-center justify-between gap-2 w-40 border hover:bg-gray-200">
            {% with current_filters|get_item:field.name as selected %}
              {{ selected|default:field.verbose_name }}
            {% endwith %}
            <i class="fa-solid fa-chevron-down text-xs"></i>
          </button>

          <div x-show="open" @click.away="open = false"
               class="absolute mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden z-20">
            {% for choice in field.choices %}
              <button type="submit" name="{{ field.name }}" value="{{ choice.0 }}"
                      class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100
                             {% if current_filters|get_item:field.name == choice.0 %} bg-[#004F9F] text-white {% endif %}">
                {{ choice.1 }}
              </button>
            {% endfor %}
            <button type="submit" name="{{ field.name }}" value=""
                    class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100
                           {% if not current_filters|get_item:field.name %} bg-[#004F9F] text-white {% endif %}">
              Tous
            </button>
          </div>
        </div>
        {% endfor %}

        <!-- Filtre Année -->
        <div class="relative" x-data="{ open: false }">
          <button type="button" @click="open = !open"
                  class="px-4 py-2 bg-gray-100 rounded-xl text-gray-700 shadow-sm text-sm flex items-center justify-between gap-2 w-40 border hover:bg-gray-200">
            {{ request.GET.annee|default:"Année" }}
            <i class="fa-solid fa-chevron-down text-xs"></i>
          </button>
          <div x-show="open" @click.away="open = false"
               class="absolute mt-2 w-40 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden z-20">
            {% for year in 2020|to_current_year %}
              <button type="submit" name="annee" value="{{ year }}"
                      class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100
                             {% if request.GET.annee == year|stringformat:"s" %} bg-[#004F9F] text-white {% endif %}">
                {{ year }}
              </button>
            {% endfor %}
            <button type="submit" name="annee" value=""
                    class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100
                           {% if not request.GET.annee %} bg-[#004F9F] text-white {% endif %}">
              Tous
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
  <!-- Exports -->
  <div class="flex flex-wrap justify-end gap-3">
    <a href="{% url 'export_attributions' %}?format=xlsx&q={{ request.GET.q }}&direction={{ request.GET.direction }}&departement={{ request.GET.departement }}&service={{ request.GET.service }}&etat={{ request.GET.etat }}&utilisateur={{ request.GET.utilisateur }}"
       class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow text-sm">
      📥 Exporter XLSX
    </a>
    <a href="{% url 'export_attributions' %}?format=csv&q={{ request.GET.q }}&direction={{ request.GET.direction }}&departement={{ request.GET.departement }}&service={{ request.GET.service }}&etat={{ request.GET.etat }}&utilisateur={{ request.GET.utilisateur }}"
       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow text-sm">
      📥 Exporter CSV
    </a>
    <a href="{% url 'export_attributions' %}?format=pdf&q={{ request.GET.q }}&direction={{ request.GET.direction }}&departement={{ request.GET.departement }}&service={{ request.GET.service }}&etat={{ request.GET.etat }}&utilisateur={{ request.GET.utilisateur }}"
       class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow text-sm">
      📥 Exporter PDF
    </a>
  </div>
  <!-- Tableau -->
  <div class="bg-white border border-gray-200 rounded-2xl shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gradient-to-r from-[#004F9F] to-[#2563EB] text-white">
        <tr>
          <th class="px-4 py-3 text-center">📅 Date</th>
          <th class="px-4 py-3">👤 Usager</th>
          <th class="px-4 py-3">🔖 Référence</th>
          <th class="px-4 py-3">💼 Matériels attribués</th>
          <th class="px-4 py-3 text-center">⚙️ Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 text-sm">
        {% for attribution in attributions %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-4 py-3 text-gray-700 text-center">{{ attribution.date_attri|date:"d/m/Y H:i" }}</td>
          <td class="px-4 py-3 font-medium text-gray-900">{{ attribution.prenom }} {{ attribution.nom }}</td>
          <td class="px-4 py-3 text-gray-600">{{ attribution.ref }}</td>
          <td class="px-4 py-3">
            <ul class="space-y-1">
              {% for item in attribution.attribumateriel_set.all %}
              <li class="flex items-center gap-2">
                <span class="text-gray-800">{{ item.materiel }}</span>
                <span class="bg-[#F58220] text-white text-xs px-2 py-1 rounded-full">{{ item.quantite }}</span>
              </li>
              {% endfor %}
            </ul>
          </td>
          <td class="px-4 py-3 text-center relative" x-data="{ open: false, confirmDelete: false }">
            <button @click="open = !open"
                    class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded-lg shadow-sm text-xs flex items-center gap-1">
              ⚙️ Actions <i class="fa-solid fa-chevron-down text-xs"></i>
            </button>
            <div x-show="open" @click.away="open = false"
                 class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg py-2 z-50 text-sm">
              <a href="{% url 'edit_attribution' attribution.id %}" class="block px-4 py-2 hover:bg-gray-100">✏️ Éditer</a>
              <a href="{% url 'attribution_detail' attribution.id %}" class="block px-4 py-2 hover:bg-gray-100">🔎 Détails</a>
              <button @click="confirmDelete = true; open = false" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">🗑 Supprimer</button>
            </div>

            <!-- Modal Suppression -->
            <div x-show="confirmDelete" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
              <div class="bg-white rounded-xl shadow-xl p-6 w-96">
                <h2 class="text-lg font-bold text-gray-800 mb-3">⚠ Confirmation</h2>
                <p class="text-gray-600 mb-6">
                  Voulez-vous vraiment supprimer l’attribution <strong>#{{ attribution.ref }}</strong> ?
                </p>
                <div class="flex justify-end gap-3">
                  <button @click="confirmDelete = false" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">❌ Annuler</button>
                  <form method="post" action="{% url 'delete_attribution' attribution.id %}">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow">🗑 Supprimer</button>
                  </form>
                </div>
              </div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="p-6 text-center text-gray-400 italic">🚫 Aucun déploiement trouvé.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>



  <!-- Pagination -->
  <div class="flex justify-center items-center gap-4">
    {% if attributions.has_previous %}
      <a href="?page={{ attributions.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}&annee={{ request.GET.annee }}"
         class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg shadow text-sm">⬅ Précédent</a>
    {% endif %}
    <span class="text-gray-600 font-medium">Page {{ attributions.number }} sur {{ attributions.paginator.num_pages }}</span>
    {% if attributions.has_next %}
      <a href="?page={{ attributions.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}&annee={{ request.GET.annee }}"
         class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg shadow text-sm">Suivant ➡</a>
    {% endif %}
  </div>

</div>
{% endblock %}
