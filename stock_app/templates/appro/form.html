{% extends "base.html" %}

{% block content %}
<div class="p-6 max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold text-green-700 mb-6 flex items-center gap-2">
    🛒 Nouvel approvisionnement
  </h1>

  <!-- Messages Django -->
  {% if messages %}
      <div class="mb-4 space-y-2">
          {% for message in messages %}
              <div class="
                  px-4 py-2 rounded-xl text-sm font-medium shadow-md
                  {% if message.tags == 'error' %}
                      bg-red-100 text-red-800 border border-red-300
                  {% elif message.tags == 'success' %}
                      bg-green-100 text-green-800 border border-green-300
                  {% elif message.tags == 'warning' %}
                      bg-yellow-100 text-yellow-800 border border-yellow-300
                  {% else %}
                      bg-blue-100 text-blue-800 border border-blue-300
                  {% endif %}
              ">
                  {{ message }}
              </div>
          {% endfor %}
      </div>
  {% endif %}

  <form method="post" class="space-y-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200" id="appro-form">
    {% csrf_token %}

    <!-- Section utilisateur-->
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
        👤 Utilisateur
      </h2>
      <div class="space-y-3">
        {{ appro_form.as_p }}
      </div>
    </div>
 
    <!-- Section matériels -->
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
        📦 Matériels
      </h2>
      {{ formset.management_form }}

      <div id="formset-container" class="space-y-4">
       
        {% for form in formset %}

        {% if forloop.first %}
          <div class="border p-4 rounded-lg bg-gray-50 shadow-sm formset-form relative">
            {{ form.as_p }}
            <!-- bouton supprimer -->
            <button type="button" 
                    class="absolute top-2 right-2 text-red-600 hover:text-red-800 font-bold remove-form">
              ❌
            </button>
          </div>
          {% endif %}
        {% endfor %}
      
      </div>

      <!-- bouton ajouter ligne -->
      <button type="button" id="add-form"  
              class="mt-4 bg-blue-700 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-800 transition">
        ➕ Ajouter un matériel
      </button>
    </div>
    
    <!-- Boutons d’action -->
    <div class="pt-6 flex justify-between">
      <a href="{% url 'liste_appros' %}" 
         class="bg-red-600 text-white px-5 py-2 rounded-lg shadow hover:bg-red-700 transition">
         🔙 Retour
      </a>
      <button type="submit" 
              class="bg-green-700 text-white px-6 py-2 rounded-lg shadow hover:bg-green-800 transition">
        ✅ Enregistrer
      </button>
    </div>
  </form>
</div>

<!-- Script dynamique -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const addButton = document.getElementById("add-form");
  const formContainer = document.getElementById("formset-container");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");

  addButton.addEventListener("click", function () {
    const currentForms = document.querySelectorAll(".formset-form");
    const formNum = currentForms.length;

    // clone le premier formulaire
    let newForm = currentForms[0].cloneNode(true);

    // nettoyer les valeurs
    newForm.querySelectorAll("input, select, textarea").forEach((el) => {
      el.name = el.name.replace(/-\d+-/, `-${formNum}-`);
      el.id = el.id.replace(/-\d+-/, `-${formNum}-`);
      if (el.type !== "hidden") {
        el.value = "";
      }
    });

    // reset bouton supprimer
    let removeBtn = newForm.querySelector(".remove-form");
    if (!removeBtn) {
      removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.innerHTML = "❌";
      removeBtn.className = "absolute top-2 right-2 text-red-600 hover:text-red-800 font-bold remove-form";
      newForm.appendChild(removeBtn);
    }

    // ajouter au container
    formContainer.appendChild(newForm);

    // mettre à jour TOTAL_FORMS
    totalForms.value = formNum + 1;

    attachRemoveEvent(newForm);
  });

  // fonction suppression d’un formulaire
  function attachRemoveEvent(formElement) {
    formElement.querySelector(".remove-form").addEventListener("click", function () {
      formElement.remove();
      const forms = document.querySelectorAll(".formset-form");
      totalForms.value = forms.length;
    });
  }

  // attacher à tous les formulaires existants
  document.querySelectorAll(".formset-form").forEach(form => attachRemoveEvent(form));
});
</script>
{% endblock %}
