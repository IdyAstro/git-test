{% extends "demandes/base.html" %}
{% load custom_filters %}

{% block content %}
<div class="p-6 max-w-6xl mx-auto">

  
    <div class="flex justify-between gap-4 mt-6 border border-1 border-[#004F9F] mb-4 px-2 py-2 rounded rounded-xl ">
      <h1 class="text-2xl font-bold text-[#004F9F] mb-6">üìã Liste compl√®te des demandes</h1>
    <a href="{% url 'creer_demande' %}" 
       class="bg-[#F58220] hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow transition">
       <i class="fa-solid fa-plus"></i>
  </a>
  </div>
  <!-- Formulaire de recherche -->
  <form method="get" class="flex items-center bg-white rounded-xl py-2 px-2 space-x-2 mb-6" x-data="{}">
    <div class="flex gap-2 mb-4">
    <input type="text" name="q" 
           placeholder="Filtrer par pr√©nom ou nom" 
           value="{{ request.GET.q }}"
           class="border border-gray-300 rounded-lg px-3 py-2 w-64 focus:ring-2 focus:ring-[#004F9F]">
    <button type="submit" 
            class="bg-[#004F9F] hover:bg-blue-900 text-white px-4 py-2 rounded-lg shadow transition">
       <i class="fa-solid fa-magnifying-glass"></i>
    </button>
    </div>
     <!-- Filtres dropdown sous la recherche -->
    <div class="flex flex-wrap gap-4">
      {% for field in radio_fields %}
        <div class="relative" x-data="{ open: false }">
          <!-- Bouton du filtre -->
          <button type="button" @click="open = !open"
                  class="px-3 py-1 bg-gray-200 rounded-lg shadow text-sm flex items-center gap-1">
            {% with current_filters|get_item:field.name as selected %}
              {{ selected|default:field.verbose_name }}
            {% endwith %}
            <svg class="w-4 h-4 transform" :class="{'rotate-180': open}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Dropdown -->
          <div x-show="open" @click.away="open = false"
               class="absolute z-10 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg py-2">
            {% for choice in field.choices %}
              <button type="submit" name="{{ field.name }}" value="{{ choice.0 }}"
                      class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100
                             {% if current_filters|get_item:field.name == choice.0 %} bg-[#004F9F] text-white {% endif %}">
                {{ choice.1 }}
              </button>
            {% endfor %}

            <!-- Option Tous -->
            <button type="submit" name="{{ field.name }}" value=""
                    class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100
                           {% if not current_filters|get_item:field.name %} bg-[#004F9F] text-white {% endif %}">
              Tous
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  </form>

  
  
  <!-- Tableau des demandes -->
  <div class="overflow-x-auto mb-4">
    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow">
      <thead class="bg-[#004F9F] text-white">
        <tr>
          <th class="px-4 py-2 text-left">Pr√©nom</th>
          <th class="px-4 py-2 text-left">Nom</th>
          <th class="px-4 py-2 text-left">Mat√©riel</th>
          <th class="px-4 py-2 text-left">Quantit√©</th>
          <th class="px-4 py-2 text-left">Direction</th>
          <th class="px-4 py-2 text-left">D√©partement</th>
          <th class="px-4 py-2 text-left">Statut</th>
          <th class="px-4 py-2 text-left">Date</th>
          <th class="px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for d in demandes %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2">{{ d.prenom }}</td>
            <td class="px-4 py-2">{{ d.nom }}</td>
            <td class="px-4 py-2">{{ d.materiel.categorie}}</td>
            <td class="px-4 py-2 text-center">{{ d.quantite }}</td>
            <td class="px-4 py-2">{{ d.direction }}</td>
            <td class="px-4 py-2">{{ d.departement }}</td>
            <td class="px-4 py-2">{{ d.get_statut_display }}</td>
            <td class="px-4 py-2">{{ d.date_demande|date:"d/m/Y H:i" }}</td>
           <td class="px-4 py-2 text-center" x-data="{ openMenu: false, showModal: false }">
  <!-- Bouton Actions -->
             <button @click="openMenu = !openMenu" 
                      class="bg-[#F58220] hover:bg-orange-600 text-white px-3 py-1 rounded-lg relative">
                     Actions <i class="fa-solid fa-caret-down ml-2"></i>
             </button>

  <!-- Menu d√©roulant -->
         <div x-show="openMenu" @click.outside="openMenu = false"
                 class="absolute mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
            <a href="{% url 'detail_demande' d.pk %}" 
               class="block px-4 py-2 text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-angle-right"></i></a>
            <a href="{% url 'modifier_demande' d.pk %}" 
               class="block px-4 py-2 text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-pen"></i></a>
            <button @click="showModal = true; openMenu = false" 
                     class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>

  <!-- Modal de confirmation -->
  <div x-show="showModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-20">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmer la suppression</h2>
      <p class="mb-6">Voulez-vous vraiment supprimer cette demande ? Cette action est irr√©versible.</p>
      <div class="flex justify-end space-x-4">
        <button @click="showModal = false" 
                class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Annuler</button>
        <form method="POST" action="{% url 'supprimer_demande' d.pk %}">
          {% csrf_token %}
          
          <button type="submit" 
                  class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">
             Supprimer
          </button>
        </form>
      </div>
    </div>
  </div>
</td>
</tr>
        {% empty %}
          <tr>
            <td colspan="9" class="text-center py-4 text-gray-500 italic">
              Aucune demande enregistr√©e.
            </td>
          </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="flex justify-start space-x-4">
  <a href="{% url 'export_demandes_xls' %}" 
       class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow transition">
       ‚¨á Exporter en xlsx
  </a>

</div>

   <!-- Pagination -->
  <div class="flex justify-center items-center space-x-4 mt-6">
    {% if demandes.has_previous %}
      <a href="?page={{ demandes.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
         class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
         ‚¨Ö Pr√©c√©dent
      </a>
    {% endif %}

    <span class="text-gray-700 font-semibold">
      Page {{ demandes.number }} sur {{ demandes.paginator.num_pages }}
    </span>

    {% if demandes.has_next %}
      <a href="?page={{ demandes.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
         class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
         Suivant ‚û°
      </a>
    {% endif %}
  </div>

</div>

{% endblock %}
